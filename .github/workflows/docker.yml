name: Build and push Docker images to Docker Hub

on:
  workflow_dispatch:
  push:
    branches:
    - develop


permissions:
  contents: read

jobs:
  build_docker_image:
    # This workflow is only of value to PyBaMM and would always be skipped in forks
    if: github.repository_owner == 'pybamm-team'
    name: Build image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0

      
      - name: Set up Docker
        run: |
          docker version
          docker info

      - name: Login to Docker Hub
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

      
      - name: Build and push Docker image to Docker Hub
        run: |
          # Build for amd64
          docker build -t pybamm/pybamm:latest -f scripts/Dockerfile --no-cache .
          # Push to Docker Hub
          docker push pybamm/pybamm:latest

      - name: List built image(s)
        run: docker images
